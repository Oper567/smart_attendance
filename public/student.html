<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Portal | UniSmart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top left, #1e293b, #0f172a); min-height: 100vh; color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .view-transition { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .otp-input::placeholder { color: rgba(59, 130, 246, 0.2); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        /* Smooth scroll for history */
        #attendanceHistory::-webkit-scrollbar { width: 4px; }
        #attendanceHistory::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="p-4">
    
    <header class="flex justify-between items-center mb-8 max-w-md mx-auto w-full">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="font-black text-lg">U</span>
            </div>
            <div>
                <h1 class="text-lg font-extrabold leading-none">Uni<span class="text-blue-500">Smart</span></h1>
                <p id="welcomeName" class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter italic">Authenticating...</p>
            </div>
        </div>
        <button onclick="logout()" class="text-xs bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-2 rounded-xl border border-red-500/20 transition-all active:scale-90">
            Sign Out
        </button>
    </header>

    <main class="max-w-md mx-auto w-full space-y-6 view-transition">
        <div class="glass-card p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4">
                <span class="flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                </span>
            </div>

            <div class="text-center mb-8">
                <h2 class="text-2xl font-extrabold mb-1">Verify Presence</h2>
                <p class="text-xs text-slate-400 uppercase tracking-widest">Live Classroom Sync</p>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-3 text-center">6-Digit Class Code</label>
                    <input type="number" id="attendanceCode" 
                        oninput="if(this.value.length > 6) this.value = this.value.slice(0,6)" 
                        placeholder="000000"
                        class="otp-input w-full bg-slate-900/50 border border-white/10 rounded-2xl py-5 text-center text-5xl font-black tracking-[0.8rem] text-blue-400 focus:outline-none focus:border-blue-500/50 transition-all">
                </div>

                <button onclick="submitAttendance()" id="submitBtn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-5 rounded-3xl shadow-xl transition-all active:scale-[0.97] flex items-center justify-center gap-2">
                    Mark Presence
                </button>
            </div>

            <p id="statusMsg" class="mt-6 text-center text-xs font-semibold hidden py-3 rounded-2xl"></p>
        </div>

        <div class="glass-card p-6 rounded-[2.5rem]">
            <div class="flex justify-between items-center mb-6 px-2">
                <h3 class="text-[11px] font-black uppercase tracking-widest text-slate-400">Your History</h3>
                <span id="recordCount" class="text-[10px] bg-white/5 px-2 py-1 rounded-md text-slate-500">0 Total</span>
            </div>
            
            <div id="attendanceHistory" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                <div class="text-center py-8 opacity-20 text-xs">Loading records...</div>
            </div>
        </div>
    </main>

<script>
    const SB_URL = 'https://olvwogdonhsxnzyhpcpv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sdndvZ2RvbmhzeG56eWhwY3B2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDIwOTgsImV4cCI6MjA4MzM3ODA5OH0.LszM2J9xryM6pVdwKb2vK2uArnzeNthAGvxCvHg-VQA';
    
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let currentUser = null;

    async function init() {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        
        if (error || !user) { 
            window.location.href = 'login.html'; 
            return; 
        }
        
        currentUser = user;
        // Get name from metadata saved during signup
        const fullName = user.user_metadata.full_name || 'Student';
        document.getElementById('welcomeName').innerText = `Welcome, ${fullName}`;
        
        loadHistory();
    }

    // Haversine formula to check distance between two coordinates
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c * 1000; // Return distance in meters
    }

    async function submitAttendance() {
        const codeInput = document.getElementById('attendanceCode');
        const btn = document.getElementById('submitBtn');
        const code = codeInput.value;

        if (code.length < 6) {
            showStatus("Enter 6-digit code", "error");
            return;
        }

        btn.disabled = true;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="animate-pulse">Locating...</span>';

        navigator.geolocation.getCurrentPosition(async (position) => {
            try {
                // 1. Find the active session matching the code
                const { data: session, error: sError } = await supabaseClient
                    .from('active_sessions')
                    .select('*')
                    .eq('otp', code)
                    .eq('is_active', true)
                    .single();

                if (sError || !session) throw new Error("Invalid or expired code.");

                // 2. Geofence check (150-meter radius)
                if (session.lat && session.lng) {
                    const distance = getDistance(position.coords.latitude, position.coords.longitude, session.lat, session.lng);
                    if (distance > 150) throw new Error(`Too far! You are ${Math.round(distance)}m away.`);
                }

                // 3. Mark Attendance in the logs
                const { error: aError } = await supabaseClient
                    .from('attendance_logs')
                    .insert([{
                        student_name: currentUser.user_metadata.full_name,
                        matric_no: currentUser.user_metadata.matric_no,
                        course_code: session.course_code,
                        session_id: session.id
                    }]);

                if (aError) {
                    if (aError.code === '23505') throw new Error("Already marked for this class!");
                    throw aError;
                }

                showStatus(`Success! Marked for ${session.course_code}`, "success");
                btn.innerHTML = "Verified ✅";
                btn.className = "w-full bg-green-600 text-white font-extrabold py-5 rounded-3xl shadow-lg";
                codeInput.value = '';
                setTimeout(() => {
                   btn.disabled = false;
                   btn.innerHTML = originalContent;
                   btn.className = "w-full bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-5 rounded-3xl shadow-xl transition-all active:scale-[0.97] flex items-center justify-center gap-2";
                }, 3000);
                
                loadHistory();

            } catch (err) {
                showStatus(err.message, "error");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }, (geoErr) => {
            showStatus("Please enable location to mark attendance.", "error");
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }, { enableHighAccuracy: true });
    }

    async function loadHistory() {
        const container = document.getElementById('attendanceHistory');
        const matric = currentUser.user_metadata.matric_no;

        const { data, error } = await supabaseClient
            .from('attendance_logs')
            .select('*')
            .eq('matric_no', matric)
            .order('signed_at', { ascending: false });

        if (error) return;
        document.getElementById('recordCount').innerText = `${data.length} Total`;

        container.innerHTML = data.length === 0 ? 
            '<div class="text-center py-10 opacity-30 text-xs">No records found</div>' :
            data.map(record => `
                <div class="flex justify-between items-center bg-white/[0.02] p-4 rounded-3xl border border-white/[0.05] mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 font-bold text-[10px]">
                            ${record.course_code.substring(0,2)}
                        </div>
                        <div>
                            <p class="font-black text-sm text-slate-200">${record.course_code}</p>
                            <p class="text-[9px] text-slate-500 uppercase">
                                ${new Date(record.signed_at).toLocaleDateString()} • ${new Date(record.signed_at).toLocaleTimeString([], {timeStyle:'short'})}
                            </p>
                        </div>
                    </div>
                    <span class="text-[8px] bg-green-500/10 text-green-400 px-3 py-1 rounded-full border border-green-500/20 font-black">PRESENT</span>
                </div>
            `).join('');
    }

    function showStatus(text, type) {
        const msg = document.getElementById('statusMsg');
        msg.innerText = text;
        msg.classList.remove('hidden');
        msg.className = `mt-6 text-center text-[11px] font-bold py-3 rounded-2xl ${
            type === 'success' ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'
        }`;
    }

    async function logout() { 
        await supabaseClient.auth.signOut(); 
        window.location.href = 'login.html'; 
    }

    init();
</script>
</body>
</html>