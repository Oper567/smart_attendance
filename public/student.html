<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Portal | UniSmart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top left, #1e293b, #020617); min-height: 100vh; color: white; overflow-x: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); transition: transform 0.3s ease; }
        .glass-card:active { transform: scale(0.99); }
        .view-transition { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .otp-input { letter-spacing: 0.5rem; transition: all 0.3s ease; }
        .otp-input:focus { letter-spacing: 0.8rem; box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #attendanceHistory::-webkit-scrollbar { width: 3px; }
        #attendanceHistory::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }
        .status-success { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-error { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <header class="flex justify-between items-center mb-6 md:mb-10 max-w-md mx-auto w-full">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                <span class="font-black text-lg text-white">U</span>
            </div>
            <div>
                <h1 class="text-lg font-extrabold tracking-tight">Uni<span class="text-blue-500">Smart</span></h1>
                <p id="welcomeName" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Verifying...</p>
            </div>
        </div>
        <button onclick="logout()" class="p-2 rounded-xl bg-white/5 text-slate-400 hover:text-red-400 border border-white/5 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </header>

    <main class="max-w-md mx-auto w-full space-y-4 md:space-y-6 view-transition pb-10">
        <div class="glass-card p-5 md:p-8 rounded-[2rem] relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-500/5 blur-[50px] rounded-full"></div>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-blue-500/10 px-3 py-1 rounded-full mb-3 border border-blue-500/20">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                    <span class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Geofence: 500m</span>
                </div>
                <h2 class="text-xl font-black text-white">Class Check-in</h2>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-[9px] uppercase font-black text-slate-500 mb-3 text-center tracking-widest">Enter 6-Digit OTP</label>
                    <input type="number" id="attendanceCode" 
                        oninput="if(this.value.length > 6) this.value = this.value.slice(0,6)" 
                        placeholder="000000"
                        class="otp-input w-full bg-slate-950/50 border border-white/10 rounded-2xl py-4 text-center text-3xl font-black text-blue-400 focus:outline-none focus:border-blue-500/50 transition-all">
                </div>

                <button onclick="submitAttendance()" id="submitBtn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                    Mark Attendance
                </button>
            </div>

            <div id="statusMsg" class="mt-4 text-center text-[10px] font-bold p-3 rounded-xl hidden"></div>
        </div>

        <div class="glass-card p-5 rounded-[2rem]">
            <div class="flex justify-between items-center mb-4 px-1">
                <div>
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Your Logs</h3>
                </div>
                <span id="recordCount" class="text-[9px] font-black bg-blue-500/10 text-blue-500 px-2 py-1 rounded-lg border border-blue-500/10">0 Logs</span>
            </div>
            
            <div id="attendanceHistory" class="space-y-2 max-h-[220px] md:max-h-[350px] overflow-y-auto pr-1">
                <div class="text-center py-8 opacity-30">
                    <p class="text-[10px] uppercase tracking-widest">Loading History...</p>
                </div>
            </div>
        </div>
    </main>

<script>
    const SB_URL = 'https://olvwogdonhsxnzyhpcpv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sdndvZ2RvbmhzeG56eWhwY3B2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDIwOTgsImV4cCI6MjA4MzM3ODA5OH0.LszM2J9xryM6pVdwKb2vK2uArnzeNthAGvxCvHg-VQA'; 
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let currentUser = null;

    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { window.location.href = 'login.html'; return; }
        currentUser = user;
        document.getElementById('welcomeName').innerText = `Hello, ${user.user_metadata.full_name || 'Student'}`;
        loadHistory();
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function submitAttendance() {
        const codeInput = document.getElementById('attendanceCode');
        const btn = document.getElementById('submitBtn');
        const code = codeInput.value;

        if (code.length !== 6) return showStatus("Enter 6-digit code", "error");

        setLoading(true);

        navigator.geolocation.getCurrentPosition(async (position) => {
            try {
                const { data: session, error: sError } = await supabaseClient
                    .from('active_sessions')
                    .select('*')
                    .eq('otp', code)
                    .eq('is_active', true)
                    .maybeSingle();

                if (sError || !session) throw new Error("Code invalid or session ended.");

                const distance = calculateDistance(
                    position.coords.latitude, 
                    position.coords.longitude, 
                    session.lat, 
                    session.lng
                );

                // Updated radius check to 500m
                if (distance > 500) {
                    throw new Error(`Out of range (${Math.round(distance)}m). Move closer.`);
                }

                const { error: aError } = await supabaseClient.from('attendance_logs').insert([{
                    student_name: currentUser.user_metadata.full_name,
                    matric_no: currentUser.user_metadata.matric_no,
                    course_code: session.course_code,
                    session_id: session.id,
                    signed_at: new Date().toISOString()
                }]);

                if (aError) {
                    if (aError.code === '23505') throw new Error("Already signed in for this class.");
                    throw aError;
                }

                showStatus(`Success: ${session.course_code}`, "success");
                codeInput.value = '';
                loadHistory();
            } catch (err) {
                showStatus(err.message, "error");
            } finally {
                setLoading(false);
            }
        }, (geoErr) => {
            showStatus("Enable GPS to mark attendance", "error");
            setLoading(false);
        }, { enableHighAccuracy: true, timeout: 10000 });
    }

    async function loadHistory() {
        const container = document.getElementById('attendanceHistory');
        const { data, error } = await supabaseClient
            .from('attendance_logs')
            .select('*')
            .eq('matric_no', currentUser.user_metadata.matric_no)
            .order('signed_at', { ascending: false });

        if (error) return;
        document.getElementById('recordCount').innerText = `${data.length} Logs`;

        if (data.length === 0) {
            container.innerHTML = `<p class="text-center py-10 opacity-20 text-[10px] font-black">NO RECORDS</p>`;
            return;
        }

        container.innerHTML = data.map(rec => `
            <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 font-black text-[10px]">
                        ${rec.course_code.substring(0,3)}
                    </div>
                    <div>
                        <p class="font-black text-xs">${rec.course_code}</p>
                        <p class="text-[8px] text-slate-500 font-bold uppercase mt-0.5">${new Date(rec.signed_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <span class="text-[7px] font-black text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded-full uppercase tracking-tighter">Verified</span>
            </div>
        `).join('');
    }

    function setLoading(isLoading) {
        const btn = document.getElementById('submitBtn');
        btn.disabled = isLoading;
        btn.innerHTML = isLoading ? "Verifying..." : "Mark Attendance";
    }

    function showStatus(text, type) {
        const msg = document.getElementById('statusMsg');
        msg.innerText = text;
        msg.classList.remove('hidden', 'status-success', 'status-error');
        msg.classList.add(type === 'success' ? 'status-success' : 'status-error');
        setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    async function logout() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }
    init();
</script>
</body>
</html>