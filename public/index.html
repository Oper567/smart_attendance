<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniSmart | All-in-One Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --accent: #3b82f6; --success: #10b981; --danger: #ef4444; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            min-height: 100vh; color: white; overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem; padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important; border-radius: 1rem; padding: 14px;
        }
        .btn-press:active { transform: scale(0.96); }
        .view-section { display: none; animation: slideUp 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .otp-display {
            font-size: 3rem; font-weight: 800; letter-spacing: 0.5rem;
            color: var(--accent); text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: var(--success); margin-right: 5px; }
    </style>
</head>
<body>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="appToast" class="toast align-items-center text-white bg-dark border-0 rounded-4" role="alert">
        <div class="d-flex">
            <div class="toast-body"><span id="toast-text"></span></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div id="app" class="container py-4">
    
    <section id="login-view" class="view-section active">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
            <div class="glass-card w-100" style="max-width: 400px;">
                <div class="text-center mb-5">
                    <h1 class="h2 fw-extrabold">Uni<span class="text-primary">Smart</span></h1>
                    <p class="text-secondary small">Secure Portal Access</p>
                </div>
                <form id="login-form">
                    <div class="mb-3">
                        <input type="email" id="login-email" class="form-control glass-input" placeholder="Email" required>
                    </div>
                    <div class="mb-4">
                        <input type="password" id="login-pass" class="form-control glass-input" placeholder="Password" required>
                    </div>
                    <button type="submit" id="login-btn" class="btn btn-primary w-100 fw-bold py-3 rounded-4 btn-press">Sign In</button>
                </form>
                <p class="mt-4 text-center small text-secondary">
                    New here? <a href="signup.html" class="text-primary fw-bold text-decoration-none">Create Account</a>
                </p>
            </div>
        </div>
    </section>

    <section id="student-view" class="view-section">
        <div class="mx-auto" style="max-width: 500px;">
            <div class="glass-card mb-4">
                <div class="d-flex justify-content-between mb-4">
                    <h3 id="student-name" class="fw-bold mb-0">Hi, Student</h3>
                    <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="bi bi-power"></i></button>
                </div>
                <div class="bg-primary bg-opacity-10 p-4 rounded-4 text-center mb-4">
                    <label class="small text-primary fw-bold mb-2">ENTER SESSION CODE</label>
                    <input type="text" id="class-code" class="form-control glass-input text-center fs-1 fw-bold" maxlength="6" placeholder="000000">
                </div>
                <button onclick="submitAttendance()" id="submit-attn-btn" class="btn btn-primary w-100 fw-bold py-3 rounded-4">Mark Attendance</button>
            </div>
        </div>
    </section>

    <section id="lecturer-view" class="view-section">
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="glass-card">
                    <h4 class="fw-bold mb-4">Live Session</h4>
                    <input type="text" id="course-name" class="form-control glass-input mb-3" placeholder="Course Name (e.g. CSC401)">
                    <button onclick="startLecturerSession()" id="start-btn" class="btn btn-primary w-100 py-3 rounded-4 fw-bold">Generate Code</button>
                    
                    <div id="otp-area" class="mt-4 text-center d-none">
                        <div class="p-3 bg-white bg-opacity-5 rounded-4 border border-white border-opacity-10">
                            <p class="small text-secondary mb-1">STUDENT JOIN CODE</p>
                            <div id="generated-otp" class="otp-display my-2">------</div>
                            <p class="text-warning small"><i class="bi bi-geo-alt"></i> Geofence Active (100m)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="glass-card h-100">
                    <h4 class="fw-bold mb-4">Attendance List</h4>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead><tr><th>Name</th><th class="text-end">Time</th></tr></thead>
                            <tbody id="attendance-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    // Supabase Configuration
    const SB_URL = 'YOUR_SUPABASE_URL';
    const SB_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    // --- VIEW CONTROLLER ---
    function switchView(viewId) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    // --- AUTHENTICATION ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;

        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) return alert(error.message);

        // Check Role
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', data.user.id).single();
        if (profile.role === 'LECTURER') switchView('lecturer-view');
        else switchView('student-view');
    });

    async function logout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // --- LECTURER LOGIC (GEOFENCING) ---
    async function startLecturerSession() {
        const course = document.getElementById('course-name').value;
        if(!course) return alert("Enter course name");

        // Get Lecturer Location
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const otp = Math.floor(100000 + Math.random() * 900000);
            const { error } = await supabase.from('active_sessions').insert([{
                course_name: course,
                otp_code: otp.toString(),
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                is_active: true
            }]);

            if (!error) {
                document.getElementById('generated-otp').innerText = otp;
                document.getElementById('otp-area').classList.remove('d-none');
            }
        });
    }

    // --- STUDENT LOGIC (DISTANCE CALCULATION) ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function submitAttendance() {
        const code = document.getElementById('class-code').value;
        const { data: session } = await supabase.from('active_sessions')
            .select('*').eq('otp_code', code).eq('is_active', true).single();

        if (!session) return alert("Invalid or expired code");

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, session.lat, session.lng);
            
            if (dist > 100) {
                alert(`Too far! You are ${Math.round(dist)}m away. You must be within 100m.`);
                return;
            }

            // Record attendance in Supabase here
            alert("Success! Presence verified.");
        });
    }
</script>
</body>
</html>